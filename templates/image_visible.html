{% extends "base.html" %}

{% block title %}åœ–åƒæ˜ç¢¼æµ®æ°´å° - é›™é‡æµ®æ°´å°ç³»çµ±{% endblock %}

{% block content %}
<div class="image-watermark-container">
    <div class="page-header">
        <h1>ğŸ–¼ï¸ åœ–åƒæ˜ç¢¼æµ®æ°´å°</h1>
        <p class="subtitle">ç‚ºåœ–åƒæ·»åŠ å¯è¦‹æ–‡å­—æµ®æ°´å°ï¼Œæ”¯æ´å–®å€‹æˆ–ç¶²æ ¼æ’åˆ—</p>
        <a href="/" class="back-link">â† è¿”å›é¦–é </a>
    </div>
    
    <div class="image-watermark-layout">
        <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="panel-header">
                <h2>âš™ï¸ æµ®æ°´å°è¨­å®š</h2>
                <div class="quick-actions">
                    <button onclick="embedVisibleWatermark()" class="btn btn-primary btn-sm">
                        <span class="icon">âœ“</span> åµŒå…¥
                    </button>
                </div>
            </div>
            
            <!-- æ–‡ä»¶ä¸Šå‚³å€ -->
            <div class="upload-section">
                <div class="form-group">
                    <label>
                        <span class="label-text">é¸æ“‡åœ–åƒ</span>
                        <span class="label-hint">æ”¯æ´ PNG, JPG, JPEG, BMP</span>
                    </label>
                    <input type="file" id="upload_image" accept="image/*" />
                </div>
            </div>
            
            <div class="panel-tabs">
                <button class="tab-btn active" onclick="showTab('basic', this)">åŸºæœ¬è¨­å®š</button>
                <button class="tab-btn" onclick="showTab('position', this)">ä½ç½®è¨­å®š</button>
                <button class="tab-btn" onclick="showTab('style', this)">æ¨£å¼è¨­å®š</button>
                <button class="tab-btn" onclick="showTab('advanced', this)">é€²éšè¨­å®š</button>
            </div>
            
            <!-- åŸºæœ¬è¨­å®šæ¨™ç±¤é  -->
            <div id="tab-basic" class="tab-content active">
                <div class="form-group">
                    <label>
                        <span class="label-text">æµ®æ°´å°æ–‡å­—</span>
                        <span class="label-hint">é¡¯ç¤ºåœ¨æµ®æ°´å°ä¸Šçš„æ–‡å­—</span>
                    </label>
                    <input type="text" id="watermark_text" value="æ©Ÿå¯†æ–‡ä»¶" placeholder="è¼¸å…¥æµ®æ°´å°æ–‡å­—" />
                </div>
                
                <div class="form-group">
                    <label>
                        <span class="label-text">æµ®æ°´å°æ¨¡å¼</span>
                        <span class="label-hint">é¸æ“‡å–®å€‹æˆ–ç¶²æ ¼æ’åˆ—</span>
                    </label>
                    <select id="position_mode" onchange="togglePositionMode()">
                        <option value="grid" selected>ç¶²æ ¼æ’åˆ—ï¼ˆå¤šå€‹æµ®æ°´å°ï¼‰</option>
                        <option value="single">å–®å€‹æµ®æ°´å°</option>
                    </select>
                </div>
                
                <div class="form-group" id="single_position_group" style="display: none;">
                    <label>
                        <span class="label-text">å–®å€‹æµ®æ°´å°ä½ç½®</span>
                    </label>
                    <select id="single_position">
                        <option value="topleft">å·¦ä¸Š</option>
                        <option value="topright">å³ä¸Š</option>
                        <option value="center">ä¸­å¤®</option>
                        <option value="bottomleft">å·¦ä¸‹</option>
                        <option value="bottomright" selected>å³ä¸‹</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <span class="label-text">é€æ˜åº¦</span>
                        <span class="label-hint" id="opacity_value">50%</span>
                    </label>
                    <input type="range" id="opacity" min="0" max="100" value="50" />
                </div>
            </div>
            
            <!-- ä½ç½®è¨­å®šæ¨™ç±¤é  -->
            <div id="tab-position" class="tab-content">
                <div class="form-group">
                    <label>
                        <span class="label-text">èµ·å§‹ X åº§æ¨™</span>
                    </label>
                    <input type="number" id="watermark_x" value="20" min="0" />
                    <span class="unit">px</span>
                </div>
                
                <div class="form-group">
                    <label>
                        <span class="label-text">èµ·å§‹ Y åº§æ¨™</span>
                    </label>
                    <input type="number" id="watermark_y" value="20" min="0" />
                    <span class="unit">px</span>
                </div>
                
                <div class="form-group">
                    <label>
                        <span class="label-text">è¡Œæ•¸ (0=è‡ªå‹•)</span>
                        <span class="label-hint">ç¶²æ ¼æ’åˆ—çš„è¡Œæ•¸</span>
                    </label>
                    <input type="number" id="watermark_rows" value="0" min="0" />
                </div>
                
                <div class="form-group">
                    <label>
                        <span class="label-text">åˆ—æ•¸ (0=è‡ªå‹•)</span>
                        <span class="label-hint">ç¶²æ ¼æ’åˆ—çš„åˆ—æ•¸</span>
                    </label>
                    <input type="number" id="watermark_cols" value="0" min="0" />
                </div>
                
                <div class="form-group">
                    <label>
                        <span class="label-text">X è»¸é–“éš”</span>
                    </label>
                    <input type="number" id="watermark_x_space" value="50" min="0" />
                    <span class="unit">px</span>
                </div>
                
                <div class="form-group">
                    <label>
                        <span class="label-text">Y è»¸é–“éš”</span>
                    </label>
                    <input type="number" id="watermark_y_space" value="50" min="0" />
                    <span class="unit">px</span>
                </div>
            </div>
            
            <!-- æ¨£å¼è¨­å®šæ¨™ç±¤é  -->
            <div id="tab-style" class="tab-content">
                <div class="form-group">
                    <label>
                        <span class="label-text">å­—é«”</span>
                    </label>
                    <select id="watermark_font">
                        <option value="å¾®è»Ÿé›…é»‘" selected>å¾®è»Ÿé›…é»‘</option>
                        <option value="Arial">Arial</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <span class="label-text">å­—é«”å¤§å°</span>
                    </label>
                    <input type="number" id="font_size" value="36" min="12" max="100" />
                    <span class="unit">px</span>
                </div>
                
                <div class="form-group">
                    <label>
                        <span class="label-text">é¡è‰²</span>
                    </label>
                    <div class="color-input-group">
                        <input type="color" id="color" value="#000000" />
                        <input type="text" id="color_text" value="#000000" placeholder="#000000" />
                    </div>
                </div>
                
                <div class="form-group">
                    <label>
                        <span class="label-text">æ—‹è½‰è§’åº¦</span>
                        <span class="label-hint" id="angle_value">0Â°</span>
                    </label>
                    <input type="range" id="watermark_angle" min="-180" max="180" value="0" />
                </div>
            </div>
            
            <!-- é€²éšè¨­å®šæ¨™ç±¤é  -->
            <div id="tab-advanced" class="tab-content">
                <div class="form-group">
                    <label>
                        <span class="label-text">æµ®æ°´å°å¯¬åº¦ (ç•™ç©º=è‡ªå‹•)</span>
                    </label>
                    <input type="number" id="watermark_width" value="" min="0" placeholder="è‡ªå‹•" />
                    <span class="unit">px</span>
                </div>
                
                <div class="form-group">
                    <label>
                        <span class="label-text">æµ®æ°´å°é«˜åº¦ (ç•™ç©º=è‡ªå‹•)</span>
                    </label>
                    <input type="number" id="watermark_height" value="" min="0" placeholder="è‡ªå‹•" />
                    <span class="unit">px</span>
                </div>
            </div>
        </div>
        
        <!-- å³å´é è¦½å€åŸŸ -->
        <div class="preview-panel">
            <div class="preview-header">
                <h2>ğŸ“„ åœ–åƒé è¦½</h2>
            </div>
            
            <div class="preview-content">
                <div id="image_preview" class="image-preview-placeholder">
                    <div class="placeholder-content">
                        <span class="placeholder-icon">ğŸ“·</span>
                        <p>è«‹ä¸Šå‚³åœ–åƒä¸¦åµŒå…¥æµ®æ°´å°</p>
                    </div>
                </div>
                
                <div id="preview_result" class="image-preview-result"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/image-watermark.css">
{% endblock %}

{% block extra_js %}
<script>
// æ¨™ç±¤é åˆ‡æ›
function showTab(tabName, element) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById('tab-' + tabName).classList.add('active');
    
    // è¨­ç½®æŒ‰éˆ•ç‚º active ç‹€æ…‹
    if (element) {
        element.classList.add('active');
    }
}

// æ›´æ–°é€æ˜åº¦é¡¯ç¤º
document.getElementById('opacity').addEventListener('input', function() {
    document.getElementById('opacity_value').textContent = this.value + '%';
});

// æ›´æ–°è§’åº¦é¡¯ç¤º
document.getElementById('watermark_angle').addEventListener('input', function() {
    document.getElementById('angle_value').textContent = this.value + 'Â°';
});

// é¡è‰²åŒæ­¥
document.getElementById('color').addEventListener('input', function() {
    document.getElementById('color_text').value = this.value;
});

document.getElementById('color_text').addEventListener('input', function() {
    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
        document.getElementById('color').value = this.value;
    }
});

// åˆ‡æ›ä½ç½®æ¨¡å¼
function togglePositionMode() {
    const mode = document.getElementById('position_mode').value;
    const singleGroup = document.getElementById('single_position_group');
    if (mode === 'single') {
        singleGroup.style.display = 'block';
    } else {
        singleGroup.style.display = 'none';
    }
}

// é è¦½ä¸Šå‚³çš„åœ–åƒ
document.getElementById('upload_image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        Utils.readFileAsDataURL(file).then(dataURL => {
            const previewDiv = document.getElementById('image_preview');
            previewDiv.innerHTML = `
                <h3>åŸå§‹åœ–åƒ</h3>
                <img src="${dataURL}" alt="åŸå§‹åœ–åƒ" class="preview-image" />
            `;
        });
    }
});

async function embedVisibleWatermark() {
    const fileInput = document.getElementById('upload_image');
    const text = document.getElementById('watermark_text').value;
    const positionMode = document.getElementById('position_mode').value;
    const opacity = parseInt(document.getElementById('opacity').value);
    const font_size = parseInt(document.getElementById('font_size').value);
    const color = document.getElementById('color').value;
    
    if (!fileInput.files.length) {
        Utils.showMessage('è«‹é¸æ“‡åœ–åƒ', 'error');
        return;
    }
    
    if (!text) {
        Utils.showMessage('è«‹è¼¸å…¥æµ®æ°´å°æ–‡å­—', 'error');
        return;
    }
    
    try {
        Utils.showMessage('æ­£åœ¨åµŒå…¥æµ®æ°´å°...', 'info');
        
        const file = fileInput.files[0];
        
        const options = {
            text: text,
            opacity: opacity,
            font_size: font_size,
            color: color,
            watermark_font: document.getElementById('watermark_font').value || 'å¾®è»Ÿé›…é»‘',
            watermark_angle: parseInt(document.getElementById('watermark_angle').value) || 0
        };
        
        if (positionMode === 'single') {
            options.position = document.getElementById('single_position').value;
        } else {
            options.position = 'grid';
            options.watermark_x = parseInt(document.getElementById('watermark_x').value) || 20;
            options.watermark_y = parseInt(document.getElementById('watermark_y').value) || 20;
            options.watermark_rows = parseInt(document.getElementById('watermark_rows').value) || 0;
            options.watermark_cols = parseInt(document.getElementById('watermark_cols').value) || 0;
            options.watermark_x_space = parseInt(document.getElementById('watermark_x_space').value) || 50;
            options.watermark_y_space = parseInt(document.getElementById('watermark_y_space').value) || 50;
            
            const width = document.getElementById('watermark_width').value;
            const height = document.getElementById('watermark_height').value;
            if (width) options.watermark_width = parseInt(width);
            if (height) options.watermark_height = parseInt(height);
        }
        
        const outputPath = await ImageWatermark.embedVisible(file, options);
        
        const resultDiv = document.getElementById('preview_result');
        resultDiv.innerHTML = `
            <div class="result-header">
                <h3>âœ“ å¸¶æ˜ç¢¼æµ®æ°´å°çš„åœ–åƒ</h3>
                <a href="${outputPath}" download class="btn btn-primary btn-sm">ä¸‹è¼‰åœ–åƒ</a>
            </div>
            <img src="${outputPath}" alt="å¸¶æµ®æ°´å°åœ–åƒ" class="preview-image" />
        `;
        
        Utils.showMessage('âœ“ æ˜ç¢¼æµ®æ°´å°å·²åµŒå…¥!', 'success');
        
    } catch (error) {
        Utils.showMessage('åµŒå…¥å¤±æ•—: ' + error.message, 'error');
    }
}
</script>
{% endblock %}
